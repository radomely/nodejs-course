# Lesson 6

- Websocket vs HTTP
- socket.io
- Чат

## Websocket

WebSocket — протокол дуплексной связи (может передавать и принимать одновременно) поверх TCP-соединения, предназначенный для обмена сообщениями между браузером и веб-сервером в режиме реального времени.
Веб-сокеты, в отличие от HTTP, позволяют работать с двунаправленным потоком данных, что делает эту технологию совершенно уникальной.

Чем же эта технология отличается от HTTP?

- В HTTP 1.1 (используется почти везде на данный момент) единственный вариант получить что-то от сервера - это отправить на него запрос. Для каждого запроса создается одно подключение к серверу. В одно время может быть только 6 одновременных подключений к одному домену. И это самая важная особенность.

- В HTTP 2.0 (новый стандарт) появилась технология Server Push и Server Side Events, которая позволяет передавать данные с сервера на клиент и наоборот. Новая версия HTTP протокола может составить конкуренцию вебсокетам, но на данный момент она не так широко используется.
 

Бывает много ситуаций когда нам нужно получить какие-то данные из сервера, которые от нас не зависят. Например сообщение от другого пользователя, либо же сообщение что на сервере закончилась обработка большого файла или еще что-либо.

Единственный способ что позволяет нам сделать такое в HTTP 1.1 версии - это полинг. Другими словами "опрос" сервера, отправка запросов через определенный интервал с надеждой что сервер уже имеет данные что нам нужны.

###Пример HTTP pooling

<img src="./images/image-6-1.webp" />

**Возможная реализация полинга**

```
(() => {
   const interval = 2000;
   
   const poll = () => { 
       setTimeout(function(){
          $.ajax({ 
            url: 'https://api.example.com/endpoint', 
            success: function(data) {
            
            if (!data) {
              // Рекурсивно выполняем следующий запрос
              poll();
            }
              // Делаем что-то с `data`
              
            }, 
            dataType: 'json'
          });
      }, interval);
  }
})();
```

###Пример websocket подключения

<img src="./images/image-6-2.webp" />

Веб-сокетам же для ответа не нужны повторяющиеся запросы. Достаточно выполнить один запрос и ждать отклика. Вы можете просто слушать сервер, который будет отправлять вам сообщения по мере готовности.

Веб-сокеты можно использовать для

- приложения реального времени;
- чат-приложения;
- IoT-приложения;
- многопользовательские игры.

### Сложности в использовании websocket подключения

- с помощью websocket вы не сможете реализовать REST API для других клиентов. Вебсокет не поддерживает CORS.

#### Примеры 

**Client**

```
<!DOCTYPE html>
<html>
<head>
  <title>Пример чата с веб-сокетом</title>
</head>
<body>
  <script>
    let ws = new WebSocket("ws://localhost:8080");
    // выводим новые сообщения в консоль
    ws.onmessage = ({data}) => {
      console.log(data);
    }
    // отправляем сообщение 
    ws.onopen = () => ws.send('Text');
  </script>
</body>
</html>
```

**Server**

```
const WebSocket = require('ws');

// создаём новый websocket-сервер
const wss = new WebSocket.Server({
  port: 8080
});

//  отправляем клиентам, когда функция clientValidator возвращает true. this — это wss.
wss.broadcast = function(data, clientValidator = () => true) {
  this.clients.forEach(client => {
    if (clientValidator(client)) {
      client.send(data);
    }
  });
}

wss.on("connection", ws => {
  // событие будет вызвано, когда клиент отправит сообщение
  ws.on('message', message => {
    //  отправляем сообщение всем, кроме автора
    wss.broadcast(message, client => client !== ws);
  });
});
```

- [Статья о вебсокетах](https://tproger.ru/translations/what-are-web-sockets/)
- [Статья об HTTP2 server push & server side events](https://habr.com/company/ruvds/blog/342346/)


### socket.io

Socket.IO это библиотека что предоставляет удобную комуникацию клиента с сервером посредством передачи сообщений. Работает на websocket подключении.

В библиотеку входит:

- Node.js сервер
- Javascript библиотека для клиента

Кроме того, библиотека предоставляет такие функции как: 
- Переподключение в случае потери соединения (например пропал интернет). Клиент будет постоянно пытаться повторно подключиться пока сервер не будет доступен снова. 
- Обнаружение разъединения с сервером/клиентом. Механизм позволяет как серверу, так и клиенту узнать если другой не отвечает.
- Возможность передачи файлов (Binary data) ArrayBuffer и Blob в браузере и Node.js
- Поддержка мультиплексирования (создание нескольких неймспейсов)
- Создание "комнат". В пределах каждого неймспейса вы можете определить произвольные каналы, называемые «Комнаты». К ним могут присоединиться сокеты. Затем вы можете транслировать сообщения любую комнату к которой присоединился сокет. Эта функция может быть полезнаой для отправки уведомлений группе пользователей или конкретному пользователю подключенному к нескольким устройствам.
  
Пример: 

```
io.on('connection', function(socket){
  socket.emit('request', /* */); // emit an event to the socket
  io.emit('broadcast', /* */); // emit an event to all connected sockets
  socket.on('reply', function(){ /* */ }); // listen to the event
});
```

- [Документация](https://socket.io/docs/)
