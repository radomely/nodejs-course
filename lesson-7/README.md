# Lesson 7

- Авторизация с помощью Json Web Token (JWT)

## Авторизация с помощью Json Web Token (JWT)

Аутентификация - проверка подлинности пользователя путём сравнения введённого им логина/пароля с данными сохранёнными в базе данных.

Авторизация - проверка прав пользователя на доступ к определенным ресурсам.


Все пользователи вашего сайта или приложения имеют абсолютно разные права доступа к нему. Например: модераторы сайта которые вносят новости и простые пользователи.
Либо же пользователи что имеют платный аккаунт и те, что имеют бесплатный.

В обоих случаях нужно каким-то образом разграничивать права этих пользователей.

Для того, чтобы пользователь мог авторизоваться в системе, у него, естественно, должна быть учётная запись в этой самой системе. Следовательно, ему нужно предоставить возможность эту учётную запись каким-то образом создать. 
Но здесь есть пара нюансов. 
Как правило, учётные данные пользователя состоят из традиционных логина и пароля (ну и необозримого количества всяких необязательных полей на вкус разработчика).

Пароли стоит хранить в шифрованном виде, для того чтобы их не смогли использовать злоумышленники. Еще более безопасный способ хранения - хеш. Это набор символов в который закодировано ваше сообщение. Раскодировать его можно лишь с помощью специального ключа. 

Даже получив в своё распоряжение хеши, злоумышленник не сможет восстановить пароли, а, следовательно, авторизоваться в системе, используя учётную запись, данные которой получил в своё распоряжение.

#### Как происходит создание  Json Web Token

- Получаем пароль от пользователя
- Генерируем хеш
- Записываем хеш
- При авторизации пользователь присылает нам логин и пароль, мы ищем его учётную запись по логину, хешируем присланный пароль, сверяем полученный хеш с тем, что записан в учётной записи
- Высылаем пользователю кодированный веб-токен
- При дальнейших действиях пользователя в системе проверяем веб-токен

Можно еще например добавить время устаревания веб-токена, проверку IP. Но базовая схема именно такова.


[О Json Web Token](http://whiteshieldsoftware.blogspot.com/2016/06/expressjs-user-login-and-registration.html)


## Домашнее задание

1. Добавить авторизацию для пользователей

    **Логин** 
    - Добавить роут `POST auth/login`
    - В запросе `POST auth/login` указать данные пользователя (`username/email`, `password`)
    - В контроллере нужно создать JWT token и отправить его на клиент как в этом демо
    - На фронтенде нужно будеть этот токен добавить в хедеры (в формате `x-auth-token: 'Bearer <token>'`) к каждому запросу что будет отправлятся на наш сервер. Этот шаг вы сделаете в `react` курсе
    - Добавить проверку на наличие токена ко всем роутам в приложении кроме `auth/login`, `auth/register`

    **Логаут**
    - Добавить роут `GET auth/logout`
    - В контроллере пока что ничего делать не нужно

    **Получение текущего пользователя** 
    - Добавить роут `GET auth/сurrent`
    - В контроллере проверить токен и отправить данные этого же юзера с DB

    **Регистрация текущего пользователя**   
    - Заменить роут `POST /signup` на `POST auth/register`
    - Логику создания юзера оставить той же
    
2. Добавить ингридиенты для товаров
    - Сделать новую коллекцию `ingredients` в DB
    ```
     {
      "name": "tomato",
      "description": "Some vegitable", 
     }
    ```
    - Добавить в коллекцию инредиентов какие-то данные
    - К существующим продуктам добавить свойство `ingredients: [{type: <ingredientId>, ref: '<ingredients model name>'}, {type: <ingredientId>, ref: '<ingredients model name>'}]`
    - При добавлении свойтсва руководствоваться [вот этой инструкцией](https://mongoosejs.com/docs/populate.html#saving-refs)
    - Когда будете доставать `product` из DB нужно использовать функцию `.populate()` чтобы достать из DB и продукт, и ингредиенты ([документация](https://mongoosejs.com/docs/populate.html#population))
    
3. Добавить комментарии к товару
    - Сделать новую коллекцию `сomments` в DB
    ```
     {
      "product": "<productId>",
      "author": "<authorId>",
      "text": "This pizza was the best", 
      "mark": 5, 
     }
    ```
    Поле `mark` - это оценка товару, которую будет ставить пользователь. От 1 до 5.
    
    **Получение коментария** 
    - сделать роут `GET comments/?productId="v123dsagasdg"`
    - в ответе нужно прислать массив с комментариями к указанному товару
    ```
     {
      "status": "success", 
      "сomments": [{ comment1 }, { comment2 }, { comment3 }]
     }
    ```
    - если комментарием нет - то отправлять
    ```
     {
      "status": "success", 
      "сomments": []
     }
    ```
    
    **Создание коментария**
    - сделать роут `POST comments`
    - в запросе слать 
        ```
         {
          "product": "<productId>",
          "author": "<authorId>",
          "text": "This pizza was the best", 
          "mark": 4, 
         }
        ```
    - сохранить данные в DB

